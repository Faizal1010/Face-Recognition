<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Story</title>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const eventCode = localStorage.getItem('eventId');
            if (eventCode) {
                fetch(`http://localhost:3000/event/check-event/${eventCode}`, {
                    method: "GET"
                })
                .then(response => {
                    if (response.ok) {
                        localStorage.setItem("eventId", eventCode);
                        savedEventId = eventCode;
                        loadLabels(eventCode);
                        loadCarouselImages(eventCode); // Trigger carousel image loading here
                        console.log("Event Code Entered:", eventCode);
                        document.getElementById("popup").style.display = "none";
                        document.getElementById("main-content").style.display = "block";
                    } else {
                        return response.json().then(data => {
                            throw new Error(data.error || "Unknown error occurred");
                        });
                    }
                })
                .catch(error => {
                    console.error("Error checking event:", error);
                    alert(error.message);
                    document.getElementById("popup").style.display = "flex";
                    document.getElementById("main-content").style.display = "none";
                });
            }
        });
    </script>
    <style>
        html {
            scroll-behavior: smooth;
        }
        /* Full-screen popup */
        #popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #popup-content {
            background: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
        }
        #main-content {
            display: none;
        }
        #eventCodeInput {
            padding: 8px;
            width: 80%;
            margin: 10px 0;
        }
        #submitBtn {
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
    <style>
        .imageGrid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 10px;
        }
        
        .imageGridItem {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            cursor: pointer;
            width: 200px;
            height: 220px;
        }
        
        .imageGridItem img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease-in-out;
        }
        
        .imageGridItem:hover img {
            transform: scale(1.1);
        }
        
        .imageLightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 999999999;
        }
        
        .imageLightbox img {
            max-width: 80%;
            max-height: 80%;
            border-radius: 8px;
        }
        
        .imageClose,
        .imagePrev,
        .imageNext {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-size: 24px;
            border-radius: 5px;
        }

        .imagePrev,
        .imageNext {
            background: rgba(62, 62, 62, 0.3);
        }
        
        .imageClose {
            top: 17px;
            right: 20px;
            font-size: 30px;
        }
        
        .imagePrev {
            left: 20px;
        }
        
        .imageNext {
            right: 20px;
        }
        
        @media (max-width: 600px) {
            .imageGrid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
            }
            .imageGridItem {
                width: 180px;
                height: 170px;
            }
            #imageLabelFilters {
                width: 100%;
            }
        }
        
        .imagePaginationButton {
            pointer-events: auto !important;
            z-index: 99999 !important;
            position: relative !important;
        }

        /* Spinner styles adapted from video file */
        .imageSpinner, .downloadSpinner, .carousel-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3BB77E;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 10;
        }

        .carousel-spinner {
            display: flex;
            width: 48px;
            height: 48px;
            border-width: 4px;
            z-index: 3;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body style="margin: 0; padding: 0; font-family: Arial, sans-serif; text-align: center;">

    <!-- Popup -->
    <div id="popup">
        <div id="popup-content">
            <h2>Enter Event Code</h2>
            <input type="text" id="eventCodeInput" placeholder="Enter code...">
            <br>
            <button id="submitBtn">Submit</button>
        </div>
    </div>

    <!-- Main Content (Hidden Initially) -->
    <div id="main-content">
        <div style="position: relative; width: 100%; height: 100vh; overflow: hidden;" id="carousel-container">
            <div class="carousel-spinner" style="display: flex;"></div>
            <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; padding: 20px; box-sizing: border-box; z-index: 2;">
                <div style="position: absolute; bottom: 30px; text-align: center;">
                    <h1 style="font-size: 2.5rem; margin: 10px 0;">Saikat & Rajrupa Stories</h1>
                    <p style="font-size: 1rem; margin: 5px 0;">THURSDAY, MAR 13, 2025</p>
                    <a href="#img-section" style="display: inline-block; margin-top: 20px; padding: 10px 20px; border: 1px solid white; color: white; text-decoration: none; font-size: 1rem;">VIEW GALLERY</a>
                    <p style="margin-top: 20px; font-size: 1rem;">📞 9901982765</p>
                    <div style="margin-top: 10px;">
                        <a style="height: 40px; width: 40px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; margin: 0 5px; background-color: white; overflow: hidden;" href="#">
                            <img src="asset/social-media-icons/facebook.png" alt="Facebook icon" style="height: 80%; width: 80%; object-fit: contain;">
                        </a>
                        <a style="height: 40px; width: 40px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; margin: 0 5px; background-color: white; overflow: hidden;" href="#">
                            <img src="asset/social-media-icons/instagram.png" alt="Instagram icon" style="height: 80%; width: 80%; object-fit: contain;">
                        </a>
                        <a style="height: 40px; width: 40px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; margin: 0 5px; background-color: white; overflow: hidden;" href="#">
                            <img src="asset/social-media-icons/whatsapp.png" alt="WhatsApp icon" style="height: 80%; width: 80%; object-fit: contain;">
                        </a>
                        <a style="height: 40px; width: 40px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; margin: 0 5px; background-color: white; overflow: hidden;" href="#">
                            <img src="asset/social-media-icons/twitter.png" alt="Twitter icon" style="height: 80%; width: 80%; object-fit: contain;">
                        </a>
                        <a style="height: 40px; width: 40px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; margin: 0 5px; background-color: white; overflow: hidden;" href="#">
                            <img src="asset/social-media-icons/youtube.png" alt="YouTube icon" style="height: 80%; width: 80%; object-fit: contain;">
                        </a>
                    </div>
                </div>
            </div>
            <script>
                let carouselImages = [];
                let currentIndex = 0;
                let sliderImages = [];
                const maxRetries = 3;
                let retryCount = 0;

                async function loadCarouselImages(eventId) {
                    if (!eventId) {
                        console.error('No eventId provided for loading carousel images');
                        document.querySelector('.carousel-spinner').style.display = 'none';
                        return;
                    }
                    try {
                        const response = await fetch(`/carousel/images/${eventId}`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        console.log('Carousel images fetched:', data);
                        carouselImages = data.images.map(img => ({
                            id: img.id,
                            data: `data:image/jpeg;base64,${img.data}`
                        }));
                        if (carouselImages.length === 0) {
                            throw new Error('No images received from backend');
                        }
                        retryCount = 0; // Reset retry count on success
                        createCarouselImages();
                        displayCarousel();
                    } catch (error) {
                        console.error('Error loading carousel images:', error);
                        if (retryCount < maxRetries) {
                            retryCount++;
                            console.log(`Retrying... Attempt ${retryCount}/${maxRetries}`);
                            setTimeout(() => loadCarouselImages(eventId), 2000);
                        } else {
                            console.error('Max retries reached. Failed to load carousel images.');
                            document.querySelector('.carousel-spinner').style.display = 'none';
                        }
                    }
                }

                function createCarouselImages() {
                    const container = document.getElementById('carousel-container');
                    // Clear any existing images
                    container.querySelectorAll('img[alt^="Wedding moment"]').forEach(img => img.remove());
                    // Create new images
                    carouselImages.forEach((img, index) => {
                        const image = document.createElement('img');
                        image.src = img.data;
                        image.alt = `Wedding moment ${index + 1}`;
                        image.style.position = 'absolute';
                        image.style.top = '0';
                        image.style.left = '0';
                        image.style.width = '100%';
                        image.style.height = '100%';
                        image.style.objectFit = 'cover';
                        image.style.objectPosition = 'center';
                        image.style.opacity = index === 0 ? '1' : '0';
                        image.style.transition = 'opacity 1s ease-in-out';
                        image.style.zIndex = index === 0 ? '1' : '0';
                        container.insertBefore(image, container.firstChild);
                    });
                    sliderImages = document.querySelectorAll('img[alt^="Wedding moment"]');
                    // Hide spinner once images are created
                    document.querySelector('.carousel-spinner').style.display = 'none';
                }

                function displayCarousel() {
                    let loadedImages = 0;
                    sliderImages.forEach((img, index) => {
                        if (img.complete && img.naturalWidth !== 0) {
                            loadedImages++;
                            img.style.opacity = index === 0 ? '1' : '0';
                            img.style.zIndex = index === 0 ? '1' : '0';
                        } else {
                            img.onload = () => {
                                loadedImages++;
                                img.style.opacity = index === 0 ? '1' : '0';
                                img.style.zIndex = index === 0 ? '1' : '0';
                                if (loadedImages === sliderImages.length) {
                                    console.log('All carousel images loaded');
                                }
                            };
                            img.onerror = () => {
                                console.error(`Failed to load image ${index + 1}`);
                                if (retryCount < maxRetries) {
                                    retryCount++;
                                    console.log(`Retrying... Attempt ${retryCount}/${maxRetries}`);
                                    setTimeout(() => loadCarouselImages(localStorage.getItem('eventId')), 2000);
                                }
                            };
                        }
                    });
                    if (loadedImages === sliderImages.length) {
                        console.log('All carousel images loaded');
                    }
                }

                function showNextImage() {
                    if (sliderImages.length === 0) return;
                    sliderImages[currentIndex].style.opacity = '0';
                    sliderImages[currentIndex].style.zIndex = '0';
                    currentIndex = (currentIndex + 1) % sliderImages.length;
                    sliderImages[currentIndex].style.opacity = '1';
                    sliderImages[currentIndex].style.zIndex = '1';
                }

                setInterval(showNextImage, 5000); // Change image every 5 seconds
            </script>
        </div>

        <div style="padding: 10px;">
            <style>
                @media (max-width: 600px) {
                    #main-container {
                        display: flex;
                        flex-direction: column;
                    }
                }
            </style>
            <div id="main-container" style="display: flex; justify-content: space-between; align-items: center;">
                <div id="imageLabelFilters" style="display: flex; align-items: center;"></div>
                <div id="grandDownloadContainer" style="display: flex; gap: 2px;">
                    <a id="videoPageLink" style="background-color: #3BB77E; color: white; border: none; border-radius: 5px; padding: 10px 20px; cursor: pointer; font-size: 16px; display: flex; justify-content: center; align-items: center; gap: 5px; text-decoration: none;" title="Download all the images under selected labels">
                        Videos<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="#ffffff" fill="none">
                            <path d="M2 11C2 7.70017 2 6.05025 3.02513 5.02513C4.05025 4 5.70017 4 9 4H10C13.2998 4 14.9497 4 15.9749 5.02513C17 6.05025 17 7.70017 17 11V13C17 16.2998 17 17.9497 15.9749 18.9749C14.9497 20 13.2998 20 10 20H9C5.70017 20 4.05025 20 3.02513 18.9749C2 17.9497 2 16.2998 2 13V11Z" stroke="currentColor" stroke-width="1.5" />
                            <path d="M17 8.90585L17.1259 8.80196C19.2417 7.05623 20.2996 6.18336 21.1498 6.60482C22 7.02628 22 8.42355 22 11.2181V12.7819C22 15.5765 22 16.9737 21.1498 17.3952C20.2996 17.8166 19.2417 16.9438 17.1259 15.198L17 15.0941" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                            <circle cx="11.5" cy="9.5" r="1.5" stroke="currentColor" stroke-width="1.5" />
                        </svg>
                    </a>
                    <button id="grandDownloadButton" style="background-color: #3BB77E; color: white; border: none; border-radius: 5px; padding: 10px 20px; cursor: pointer; font-size: 16px; display: flex; justify-content: center; align-items: center; gap: 5px;" title="Download all the images under selected labels">
                        <span id="downloadText">Download</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="white" fill="none">
                            <path d="M12 14.5L12 4.5M12 14.5C11.2998 14.5 9.99153 12.5057 9.5 12M12 14.5C12.7002 14.5 14.0085 12.5057 14.5 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M20 16.5C20 18.982 19.482 19.5 17 19.5H7C4.518 19.5 4 18.982 4 16.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <a id="findYourselfLink" style="background-color: #3BB77E; color: white; border: none; border-radius: 5px; padding: 10px 20px; cursor: pointer; font-size: 16px; display: flex; justify-content: center; align-items: center; gap: 5px; text-decoration: none;">
                        Find Yourself<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="white" fill="none">
                            <path d="M2.5 8.18677C2.60406 6.08705 2.91537 4.77792 3.84664 3.84664C4.77792 2.91537 6.08705 2.60406 8.18677 2.5M21.5 8.18677C21.3959 6.08705 21.0846 4.77792 20.1534 3.84664C19.2221 2.91537 17.9129 2.60406 15.8132 2.5M15.8132 21.5C17.9129 21.3959 19.2221 21.0846 20.1534 20.1534C21.0846 19.2221 21.3959 17.9129 21.5 15.8132M8.18676 21.5C6.08705 21.3959 4.77792 21.0846 3.84664 20.1534C2.91537 19.2221 2.60406 17.9129 2.5 15.8132" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M17.5 17L17.2978 16.1511C17.1307 15.4497 16.5989 14.8925 15.9061 14.6929L13.5 13.9994L13.4997 12.5318C14.3964 11.9266 14.9997 10.7955 14.9997 9.5C14.9997 7.567 13.6565 6 11.9997 6C10.3428 6 8.99966 7.567 8.99966 9.5C8.99966 10.7955 9.60296 11.9266 10.4997 12.5318L10.5 13.9994L8.10885 14.6994C7.43747 14.896 6.91757 15.429 6.73787 16.1051L6.5 17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </a>
                </div>
            </div>

            <div class="image-section" id="img-section">
                <div style="display: flex; justify-content: center; align-items: center;">
                    <div class="imageGrid" id="imageContainer"></div>
                    <div class="imageLightbox" id="imageLightbox">
                        <span class="imageClose" onclick="closeImageLightbox()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="white" fill="none">
                            <path d="M18 6L12 12M12 12L6 18M12 12L18 18M12 12L6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        </svg></span>
                        <img id="imageLightboxImg">
                        <button class="imagePrev" onclick="changeImageDisplay(-1)">❮</button>
                        <button class="imageNext" onclick="changeImageDisplay(1)">❯</button>
                    </div>
                </div>
                <div id="imagePagination" style="display: flex; gap: 5px; margin-top: 10px; flex-wrap:wrap;"></div>
            </div>
        </div>
    </div>

    <script>
        let savedEventId = localStorage.getItem("eventId");
        document.addEventListener("DOMContentLoaded", function () {
            if (savedEventId) {
                const findYourselfLink = document.getElementById("findYourselfLink");
                findYourselfLink.href = `http://localhost:3000/find?eventId=${encodeURIComponent(savedEventId)}`;

                const videoPageLink = document.getElementById("videoPageLink");
                videoPageLink.href = `http://localhost:3000/video?eventId=${encodeURIComponent(savedEventId)}`;
                loadLabels(savedEventId);
                loadCarouselImages(savedEventId); // Trigger carousel image loading here
                document.getElementById("popup").style.display = "none";
                document.getElementById("main-content").style.display = "block";
            }
        });

        document.getElementById("submitBtn").addEventListener("click", function () {
            let eventId = document.getElementById("eventCodeInput").value.trim();
            if (!eventId) {
                alert("Please enter a valid event code.");
                document.getElementById("popup").style.display = "flex";
                document.getElementById("main-content").style.display = "none";
                return;
            }

            fetch(`http://localhost:3000/event/check-event/${eventId}`, {
                method: "GET"
            })
            .then(response => {
                if (response.ok) {
                    localStorage.setItem("eventId", eventId);
                    savedEventId = eventId;
                    loadLabels(eventId);
                    loadCarouselImages(eventId); // Trigger carousel image loading here
                    console.log("Event Code Entered:", eventId);
                    document.getElementById("popup").style.display = "none";
                    document.getElementById("main-content").style.display = "block";
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || "Unknown error occurred");
                    });
                }
            })
            .catch(error => {
                console.error("Error checking event:", error);
                alert(error.message);
                document.getElementById("popup").style.display = "flex";
                document.getElementById("main-content").style.display = "none";
            });
        });
    </script>

    <script>
        let images = [];
        let currentPage = 1;
        let imagesPerPage = 20;
        let selectedLabels;

        async function loadLabels(eventId) {
            console.log(eventId);
            const response = await fetch(`http://localhost:3000/get-labels/${eventId}`);
            const labels = await response.json();
            console.log("labels are ", new Set(labels));
            const labelFilters = document.getElementById('imageLabelFilters');
            labelFilters.innerHTML = '';

            new Set(labels).forEach(label => {
                const labelContainer = document.createElement('label');
                labelContainer.classList.add('custom-checkbox-label');
                labelContainer.style.fontSize = '12px';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = label;
                checkbox.classList.add('imageLabelCheckbox');
                checkbox.checked = true;

                const tickElement = document.createElement('span');
                tickElement.classList.add('tick');
                tickElement.style.fontSize = '12px';
                tickElement.innerText = '✓';

                labelContainer.appendChild(checkbox);
                labelContainer.appendChild(tickElement);
                labelContainer.appendChild(document.createTextNode(` ${label}`));

                labelFilters.appendChild(labelContainer);

                labelContainer.style.backgroundColor = "#3BB77E";
                if (checkbox.checked) {
                    tickElement.style.visibility = 'visible';
                } else {
                    tickElement.style.visibility = 'hidden';
                }

                checkbox.addEventListener('change', function() {
                    tickElement.style.visibility = this.checked ? 'visible' : 'hidden';
                    updateSelectedLabels(eventId);
                });
            });

            const style = document.createElement('style');
            style.innerHTML = `
                .custom-checkbox-label {
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    padding: 8px 16px;
                    margin: 5px;
                    border-radius: 25px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    background-color: #3BB77E;
                    color: white;
                    border: none;
                    transition: 0.3s ease-in-out;
                    position: relative;
                }
                .custom-checkbox-label:hover {
                    opacity: 0.9;
                }
                .imageLabelCheckbox {
                    display: none;
                }
                .tick {
                    font-size: 20px;
                    color: white;
                    visibility: hidden;
                }
                #imageLabelFilters {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 10px;
                }
            `;
            document.head.appendChild(style);

            selectedLabels = Array.from(new Set(labels));
            console.log("Selected Labels (initial):", selectedLabels);

            loadImages(eventId);
        }

        function updateSelectedLabels(eventId) {
            selectedLabels = [...document.querySelectorAll('.imageLabelCheckbox:checked')].map(cb => cb.value);
            console.log("Selected Labels (updated):", selectedLabels);
            currentPage = 1;
            loadImages(savedEventId);
        }
                
        async function loadImages(eventId) {
            const gallery = document.getElementById("imageContainer");
            gallery.innerHTML = "";

            if (!selectedLabels || selectedLabels.length === 0) {
                gallery.innerHTML = "<p>No images available. Please select at least one label.</p>";
                totalPages = 1;
                createPaginationButtons();
                return;
            }

            let url = 'http://localhost:3000/label-based-fetch';
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    labels: Array.from(selectedLabels),
                    page: currentPage,
                    limit: imagesPerPage,
                    eventId
                })
            };

            gallery.innerHTML = `<h3>Loading your images...</h3>`;
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Fetch failed: ${response.status} - ${errorData.error}`);
                }
                const imagesData = await response.json();

                images = imagesData.images.map(img => ({
                    data: `data:image/jpeg;base64,${img.data}`,
                    id: img.id
                }));
                totalPages = imagesData.totalPages;

                displayImages(images);
                createPaginationButtons();
            } catch (error) {
                console.error("Error in loadImages:", error);
                gallery.innerHTML = "<p>Failed to load images. Please try again later.</p>";
            }
        }

        function displayImages(images) {
            const gallery = document.getElementById("imageContainer");
            gallery.innerHTML = "";
            images.forEach((src, index) => {
                const div = document.createElement("div");
                div.className = "imageGridItem";
                div.setAttribute("data-id", src.id);
                div.style.position = "relative";

                const image = document.createElement("img");
                image.src = src.data;
                image.loading = "lazy";
                image.alt = `Image ${src.id}`;
                image.style.display = "block";

                const downloadButton = document.createElement("button");
                downloadButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="white" fill="none">
                    <path d="M12 14.5L12 4.5M12 14.5C11.2998 14.5 9.99153 12.5057 9.5 12M12 14.5C12.7002 14.5 14.0085 12.5057 14.5 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M20 16.5C20 18.982 19.482 19.5 17 19.5H7C4.518 19.5 4 18.982 4 16.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>`;
                downloadButton.style.position = "absolute";
                downloadButton.style.top = "10px";
                downloadButton.style.right = "10px";
                downloadButton.style.backgroundColor = "rgba(255, 255, 255, 0)";
                downloadButton.style.border = "none";
                downloadButton.style.borderRadius = "5px";
                downloadButton.style.padding = "3px";
                downloadButton.style.cursor = "pointer";
                downloadButton.style.opacity = "0";
                downloadButton.style.transition = "opacity 0.2s ease-in-out";

                // Spinner for image loading
                const spinner = document.createElement("div");
                spinner.className = "imageSpinner";
                spinner.style.display = "none";

                downloadButton.onclick = async () => {
                    try {
                        const response = await fetch(`http://localhost:3000/original/${src.id}`, {
                            method: 'GET',
                        });
                        if (!response.ok) throw new Error('Failed to fetch original image');
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement("a");
                        link.href = url;
                        link.download = `image_${src.id}.jpg`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    } catch (error) {
                        console.error("Error downloading image:", error);
                        alert("Failed to download the image.");
                    }
                };

                div.addEventListener('mouseenter', () => {
                    if (spinner.style.display === "none") {
                        downloadButton.style.opacity = "1";
                    }
                });
                div.addEventListener('mouseleave', () => {
                    downloadButton.style.opacity = "0";
                });

                image.onclick = () => {
                    spinner.style.display = "block"; // Show spinner
                    setTimeout(() => openImageLightbox(index, spinner), 100); // Slight delay to ensure spinner visibility
                };

                div.appendChild(image);
                div.appendChild(downloadButton);
                div.appendChild(spinner);
                gallery.appendChild(div);
            });
        }

        function createPaginationButtons() {
            const paginationContainer = document.getElementById("imagePagination");
            paginationContainer.innerHTML = "";

            if (totalPages <= 1) return;

            const maxVisibleButtons = 4;
            const ellipsis = "...";

            function createButton(pageNum, isActive = false) {
                const button = document.createElement("button");
                button.style.backgroundColor = isActive ? '#FF5733' : '#3BB77E';
                button.style.borderRadius = '5px';
                button.style.border = 'none';
                button.style.padding = '6px';
                button.style.height = '30px';
                button.style.width = '30px';
                button.style.color = 'white';
                button.style.cursor = 'pointer';
                button.innerText = pageNum;
                button.classList.add("imagePaginationButton");

                button.addEventListener("click", () => {
                    console.log(`Clicked page ${pageNum}`);
                    changePage(pageNum);
                });

                return button;
            }

            function createEllipsis() {
                const span = document.createElement("span");
                span.innerText = ellipsis;
                span.style.padding = '6px';
                span.style.color = 'green';
                span.style.cursor = 'default';
                return span;
            }

            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) {
                    paginationContainer.appendChild(createButton(i, i === currentPage));
                }
                return;
            }

            paginationContainer.appendChild(createButton(1, currentPage === 1));

            if (currentPage <= 3) {
                for (let i = 2; i <= Math.min(4, totalPages - 2); i++) {
                    paginationContainer.appendChild(createButton(i, i === currentPage));
                }
                if (totalPages > 5) {
                    paginationContainer.appendChild(createEllipsis());
                    paginationContainer.appendChild(createButton(totalPages - 1, currentPage === totalPages - 1));
                    paginationContainer.appendChild(createButton(totalPages, currentPage === totalPages));
                }
            } else if (currentPage >= totalPages - 2) {
                if (totalPages > 5) {
                    paginationContainer.appendChild(createEllipsis());
                    for (let i = totalPages - 3; i <= totalPages; i++) {
                        paginationContainer.appendChild(createButton(i, i === currentPage));
                    }
                }
            } else {
                paginationContainer.appendChild(createEllipsis());
                const startPage = Math.max(2, currentPage - 1);
                const endPage = Math.min(totalPages - 1, currentPage + 1);
                for (let i = startPage; i <= endPage; i++) {
                    paginationContainer.appendChild(createButton(i, i === currentPage));
                }
                if (endPage < totalPages - 1) {
                    paginationContainer.appendChild(createEllipsis());
                    paginationContainer.appendChild(createButton(totalPages - 1, currentPage === totalPages - 1));
                    paginationContainer.appendChild(createButton(totalPages, currentPage === totalPages));
                }
            }
        }

        function changePage(page) {
            console.log("Button Clicked: Page", page);
            if (page !== currentPage) {
                currentPage = page;
                console.log(`Page changed to: ${currentPage}`);
                loadImages(savedEventId);
            }
        }

        function openImageLightbox(index, spinner) {
            currentIndex = index;
            document.getElementById("imageLightbox").style.display = "flex";
            document.body.style.overflow = "hidden";
            updateImageLightbox();
            spinner.style.display = "none"; // Hide spinner once lightbox opens
        }

        function closeImageLightbox() {
            document.getElementById("imageLightbox").style.display = "none";
            document.body.style.overflow = "auto";
        }

        function changeImageDisplay(step) {
            currentIndex = (currentIndex + step + images.length) % images.length;
            updateImageLightbox();
        }

        function updateImageLightbox() {
            const lightboxImg = document.getElementById("imageLightboxImg");
            lightboxImg.src = images[currentIndex].data;

            let downloadButton = document.getElementById("lightboxDownloadButton");
            if (!downloadButton) {
                downloadButton = document.createElement("button");
                downloadButton.id = "lightboxDownloadButton";
                downloadButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="white" fill="none">
                    <path d="M12 14.5L12 4.5M12 14.5C11.2998 14.5 9.99153 12.5057 9.5 12M12 14.5C12.7002 14.5 14.0085 12.5057 14.5 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M20 16.5C20 18.982 19.482 19.5 17 19.5H7C4.518 19.5 4 18.982 4 16.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>`;
                downloadButton.style.position = "absolute";
                downloadButton.style.top = "0px";
                downloadButton.style.right = "60px";
                downloadButton.style.backgroundColor = "rgba(255, 255, 255, 0)";
                downloadButton.style.border = "none";
                downloadButton.style.borderRadius = "5px";
                downloadButton.style.padding = "3px";
                downloadButton.style.cursor = "pointer";

                downloadButton.onclick = async () => {
                    try {
                        const response = await fetch(`http://localhost:3000/original/${images[currentIndex].id}`, {
                            method: 'GET',
                        });
                        if (!response.ok) throw new Error('Failed to fetch original image');
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement("a");
                        link.href = url;
                        link.download = `image_${images[currentIndex].id}.jpg`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    } catch (error) {
                        console.error("Error downloading image:", error);
                        alert("Failed to download the image.");
                    }
                };

                document.getElementById("imageLightbox").appendChild(downloadButton);
            }
        }
        
        async function downloadAllSelectedImages(eventId) {
    if (!selectedLabels || selectedLabels.length === 0) {
        alert("No labels selected to download.");
        return;
    }

    const downloadButton = document.getElementById('grandDownloadButton');
    const originalContent = downloadButton.innerHTML; // Save original content (text + SVG)
    const downloadSpinner = document.createElement("div");
    downloadSpinner.className = "downloadSpinner";
    downloadSpinner.style.display = "flex"; // Use flex to center the spinner
    downloadSpinner.style.justifyContent = "center"; // Center horizontally
    downloadSpinner.style.alignItems = "center"; // Center vertically
    downloadSpinner.style.width = "24px"; // Match original spinner size
    downloadSpinner.style.height = "24px"; // Match original spinner size
    downloadSpinner.style.margin = "auto"; // Ensure centering within button
    downloadSpinner.style.position = "relative"; // Relative to button
    downloadButton.innerHTML = ""; // Clear content
    downloadButton.appendChild(downloadSpinner); // Append spinner

    try {
        const response = await fetch('http://localhost:3000/download-all-selected', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                labels: Array.from(selectedLabels),
                eventId
            })
        });

        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(`Failed to fetch ZIP: ${response.status} - ${errorData}`);
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `event_${eventId}_images.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);

        console.log("ZIP file downloaded successfully");
    } catch (error) {
        console.error("Error downloading ZIP:", error);
        alert("Failed to download images. Check the console for details.");
    } finally {
        downloadButton.innerHTML = originalContent; // Restore original content
    }
}
        document.addEventListener('DOMContentLoaded', () => {
            const grandDownloadButton = document.getElementById('grandDownloadButton');
            grandDownloadButton.addEventListener('click', () => downloadAllSelectedImages(savedEventId));
        });

        setTimeout(() => {
            const labelFilters = document.getElementById('imageLabelFilters');
            labelFilters.style.overflowX = "auto";
            labelFilters.style.flexWrap = "nowrap";
            labelFilters.style.whiteSpace = "nowrap";
            labelFilters.style.maxWidth = "95%";
        }, 100);
    </script>
</body>
</html>